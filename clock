#!/bin/sh
# clock -- big clock on a text screen.
# Author: Luis Colorado <luiscoloradourcola@gmail.com>
# Date: Sun Mar 25 12:46:44 EEST 2018

BANNEROPTS=-fu
DATE=/bin/date
ECHO=/bin/echo
SLEEP=/bin/sleep
WC=/usr/bin/wc
g="[32m"
c="[36m"
eol="[K"
r="[m"

if [ -z "$1" ]
then
	TYPE=timezoned
else
	TYPE=$1
fi

while read name DELAY FORMAT
do
	[ "$name" = "$TYPE" ] && break
done <<EOF
	complete	0.1 w%W-j%j%n%x %a%n%X %Z
	full		0.1 w%W-j%j%n%x %a%n%X %Z
	time		0.1	%X
	short		2	%H:%M
	timezoned	0.2	%X %Z
	epoch		0.2	%s
	dated		0.2	%x %a%n%X %Z
EOF

# echo TYPE=$TYPE, DELAY=$DELAY, FORMAT=$FORMAT >&2

OD=""
while true
do
	D="$(${DATE} "+${FORMAT:-${TYPE}}")"
	if [ "$D" != "$OD" ]
	then
		[ -z "$OD" ] || ${ECHO} -n "[${L}A"
		O="$(${ECHO} "$D" | banner "${BANNEROPTS}" | sed '
									1s/^/'"${g}"'/
									s/#.*#/'"${c}&${g}"'/
									s/#/0/g
									$s/$/'"${r}"'/
									s/.*/'"&${eol}"'/
									')"
		L="$(${ECHO} "$O" | ${WC} -l | sed 's/[ 	]*//')"
		${ECHO} "$O"
	else
		${SLEEP} "${DELAY:-1}"
	fi
	OD=$D
done
